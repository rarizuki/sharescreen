<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Screen Share - Link + Password (Firebase + WebRTC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      border-radius: 12px;
      border: 1px solid #1e293b;
      padding: 16px;
      background: #020617;
      margin-top: 12px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #cbd5f5;
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #1f2933;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      margin-bottom: 8px;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-top: 6px;
      margin-right: 6px;
      background: #3b82f6;
      color: white;
    }
    button.secondary {
      background: #111827;
      border: 1px solid #374151;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
    }
    .col {
      flex: 1 1 300px;
      min-width: 0;
    }
    video {
      width: 100%;
      max-height: 350px;
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1e293b;
      object-fit: contain;
    }
    .status {
      font-size: 12px;
      margin-top: 8px;
      color: #9ca3af;
    }
    .status span {
      font-weight: 600;
      color: #e5e7eb;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #111827;
      border: 1px solid #374151;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    @media (max-width: 600px) {
      body { padding: 8px; }
    }
  </style>
  <!-- Firebase compat SDK (v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>Screen Share via Link + Password</h1>
    <p style="text-align:center;font-size:13px;color:#9ca3af;">
      Host (Penyiar) cukup share <strong>link room</strong> + <strong>password</strong>.  
      Viewer (Penonton) buka link yang sama dan masukkan password â†’ langsung lihat layar.
    </p>

    <div class="card">
      <div class="badge">Konfigurasi Room</div>

      <label for="roomId">Room ID</label>
      <input id="roomId" type="text" placeholder="contoh: RIFKI123" />

      <label for="roomPassword">Password Room</label>
      <input id="roomPassword" type="password" placeholder="contoh: polres-2025" />

      <div class="hint">
        Room ID bisa dimasukkan di query: <code>?room=RIFKI123</code>.  
        Share link + password ke penonton.
      </div>

      <button id="btnStartBroadcaster">Mulai sebagai Penyiar (Host)</button>
      <button id="btnStartViewer" class="secondary">Gabung sebagai Penonton (Viewer)</button>
      <button id="btnHangup" class="secondary" disabled>Akhiri Koneksi</button>

      <div class="status" id="roleStatus">
        Mode: <span>Belum dipilih</span>
      </div>
      <div class="status" id="connectionStatus">
        Koneksi: <span>Idle</span>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="card">
          <div class="badge">Penyiar (Local Preview)</div>
          <video id="localVideo" autoplay playsinline muted></video>
          <div class="hint">
            Ini preview layar yang kamu share (hanya muncul di sisi Penyiar).
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <div class="badge">Penonton (Remote View)</div>
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="hint">
            Di sisi Penonton, video ini akan menampilkan layar dari Penyiar.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== 1. FIREBASE INIT (GANTI CONFIG DI SINI) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDF5mcwdCbdBdYzkzgtUWLTQJoc_kMLlyQ",
      authDomain: "bocco-screen.firebaseapp.com",
      databaseURL: "https://bocco-screen-default-rtdb.asia-southeast1.firebasedatabase.app/", // penting untuk Realtime DB
      projectId: "bocco-screen",
      storageBucket: "bocco-screen.firebasestorage.app",
      messagingSenderId: "585522231994",
      appId: "1:585522231994:web:9cf8e9fe29e2bb2318e083",
      measurementId: "G-ZRFHFT31QH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ====== 2. ELEMENT DOM ======
    const roomIdInput = document.getElementById('roomId');
    const roomPasswordInput = document.getElementById('roomPassword');
    const btnStartBroadcaster = document.getElementById('btnStartBroadcaster');
    const btnStartViewer = document.getElementById('btnStartViewer');
    const btnHangup = document.getElementById('btnHangup');

    const roleStatusSpan = document.getElementById('roleStatus').querySelector('span');
    const connectionStatusSpan = document.getElementById('connectionStatus').querySelector('span');

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    // Auto isi room dari query ?room=
    const params = new URLSearchParams(window.location.search);
    const qRoom = params.get('room');
    if (qRoom) roomIdInput.value = qRoom;

    // ====== 3. WEBRTC OBJECTS ======
    const pcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };
    let pc = null;
    let localStream = null;
    let roomRef = null;
    let role = null; // 'broadcaster' atau 'viewer'

    let offerListener = null;
    let answerListener = null;
    let broadcasterCandidatesListener = null;
    let viewerCandidatesListener = null;

    function logStatus(roleText, connText) {
      if (roleText !== undefined) roleStatusSpan.textContent = roleText;
      if (connText !== undefined) connectionStatusSpan.textContent = connText;
      console.log('STATUS:', {role: roleStatusSpan.textContent, conn: connectionStatusSpan.textContent});
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(pcConfig);

      pc.onicecandidate = event => {
        if (!event.candidate || !roomRef || !role) return;
        const candidatesPath = role === 'broadcaster'
          ? roomRef.child('broadcasterCandidates')
          : roomRef.child('viewerCandidates');
        candidatesPath.push(event.candidate.toJSON());
      };

      pc.ontrack = event => {
        const [stream] = event.streams;
        console.log('Remote stream received:', stream);
        remoteVideo.srcObject = stream;
        logStatus(undefined, 'Terhubung (stream diterima)');
      };

      pc.oniceconnectionstatechange = () => {
        console.log('ICE state:', pc.iceConnectionState);
        if (['disconnected', 'failed', 'closed'].includes(pc.iceConnectionState)) {
          logStatus(undefined, 'Terputus / ditutup');
        }
      };
    }

    // ====== 4. UTIL ROOM ID + PASSWORD ======
    function getRoomIdAndPassword() {
      const roomId = roomIdInput.value.trim();
      const password = roomPasswordInput.value.trim();
      if (!roomId) {
        alert('Isi Room ID dulu.');
        return null;
      }
      if (!password) {
        alert('Isi Password Room dulu.');
        return null;
      }
      return { roomId, password };
    }

    async function checkOrCreateRoomAsBroadcaster(roomId, password) {
      roomRef = db.ref('rooms/' + roomId);
      const snap = await roomRef.once('value');
      const data = snap.val();

      if (data && data.password && data.password !== password) {
        throw new Error('Password room tidak cocok dengan yang sudah ada.');
      }

      // Jika belum ada, buat room baru
      if (!data) {
        await roomRef.set({
          password: password,
          createdAt: Date.now()
        });
      }
    }

    async function checkRoomAsViewer(roomId, password) {
      roomRef = db.ref('rooms/' + roomId);
      const snap = await roomRef.once('value');
      const data = snap.val();

      if (!data) {
        throw new Error('Room belum dibuat oleh Penyiar.');
      }
      if (data.password !== password) {
        throw new Error('Password salah.');
      }
    }

    // ====== 5. PENYIAR (HOST) ======
    btnStartBroadcaster.addEventListener('click', async () => {
      if (role) {
        alert('Role sudah dipilih: ' + role + '. Refresh page untuk ganti.');
        return;
      }

      const info = getRoomIdAndPassword();
      if (!info) return;
      const { roomId, password } = info;
      logStatus('Penyiar (Host)', 'Inisialisasi...');

      try {
        await checkOrCreateRoomAsBroadcaster(roomId, password);

        createPeerConnection();
        role = 'broadcaster';

        // Ambil layar
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });

        // Buat offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // Simpan offer di Firebase
        await roomRef.child('offer').set({
          type: offer.type,
          sdp: offer.sdp
        });

        logStatus('Penyiar (Host)', 'Offer dikirim, menunggu Answer dari Penonton...');

        // Listener answer
        answerListener = roomRef.child('answer').on('value', async snap => {
          const answer = snap.val();
          if (!answer) return;
          console.log('Answer diterima:', answer);
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            logStatus('Penyiar (Host)', 'Answer diset, koneksi hampir siap...');
          }
        });

        // Listener viewerCandidates
        viewerCandidatesListener = roomRef.child('viewerCandidates').on('child_added', async snap => {
          const candidate = snap.val();
          if (candidate && pc) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
              console.error('Gagal add viewer ICE candidate:', e);
            }
          }
        });

        btnHangup.disabled = false;
      } catch (err) {
        console.error(err);
        alert('Gagal mulai sebagai Penyiar: ' + err.message);
        logStatus('Error', err.message);
      }
    });

    // ====== 6. PENONTON (VIEWER) ======
    btnStartViewer.addEventListener('click', async () => {
      if (role) {
        alert('Role sudah dipilih: ' + role + '. Refresh page untuk ganti.');
        return;
      }

      const info = getRoomIdAndPassword();
      if (!info) return;
      const { roomId, password } = info;
      logStatus('Penonton (Viewer)', 'Inisialisasi...');

      try {
        await checkRoomAsViewer(roomId, password);

        createPeerConnection();
        role = 'viewer';

        // Ambil offer dari Firebase
        const offerSnap = await roomRef.child('offer').once('value');
        const offer = offerSnap.val();
        if (!offer) {
          throw new Error('Offer belum dibuat oleh Penyiar. Pastikan Penyiar sudah start.');
        }

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        // Buat answer
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Simpan answer di Firebase
        await roomRef.child('answer').set({
          type: answer.type,
          sdp: answer.sdp
        });

        logStatus('Penonton (Viewer)', 'Answer dikirim, menunggu media...');

        // Listener broadcasterCandidates
        broadcasterCandidatesListener = roomRef.child('broadcasterCandidates').on('child_added', async snap => {
          const candidate = snap.val();
          if (candidate && pc) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
              console.error('Gagal add broadcaster ICE candidate:', e);
            }
          }
        });

        btnHangup.disabled = false;
      } catch (err) {
        console.error(err);
        alert('Gagal gabung sebagai Penonton: ' + err.message);
        logStatus('Error', err.message);
      }
    });

    // ====== 7. HANGUP & CLEANUP ======
    btnHangup.addEventListener('click', async () => {
      if (!pc) return;

      pc.getSenders().forEach(sender => {
        if (sender.track) sender.track.stop();
      });
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
      }

      pc.close();
      pc = null;

      if (offerListener && roomRef) roomRef.child('offer').off('value', offerListener);
      if (answerListener && roomRef) roomRef.child('answer').off('value', answerListener);
      if (broadcasterCandidatesListener && roomRef) roomRef.child('broadcasterCandidates').off('child_added', broadcasterCandidatesListener);
      if (viewerCandidatesListener && roomRef) roomRef.child('viewerCandidates').off('child_added', viewerCandidatesListener);

      // Opsional: hapus room jika yang menutup adalah penyiar
      try {
        if (role === 'broadcaster' && roomRef) {
          await roomRef.remove();
        }
      } catch (e) {
        console.warn('Gagal remove room (boleh diabaikan):', e);
      }

      roomRef = null;
      role = null;
      btnHangup.disabled = true;
      logStatus('Belum dipilih', 'Disconnected');
      alert('Koneksi ditutup. Refresh page jika mau mulai lagi.');
    });

    logStatus('Belum dipilih', 'Idle');
  </script>
</body>
</html>
