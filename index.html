<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Bocco Screen Share - Link + Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- AOS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />

  <!-- iziToast CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css" />

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- AOS JS -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- iziToast JS -->
  <script src="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

  <div class="max-w-4xl mx-auto px-4 py-6">
    <!-- HEADER -->
    <header class="text-center mb-6" data-aos="fade-down">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
        Bocco <span class="text-indigo-400">Screen Share</span>
      </h1>
      <p class="text-sm md:text-base text-slate-400 mt-2">
        Host tinggal buat link, kirim ke viewer, viewer masuk dengan password lalu langsung lihat layar.
      </p>
    </header>

    <!-- CARD UTAMA -->
    <div class="bg-slate-950/60 border border-slate-800 rounded-2xl shadow-xl p-4 md:p-6 space-y-4" data-aos="fade-up">
      <!-- TAB -->
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="inline-flex rounded-full bg-slate-800/80 p-1">
          <button id="tabHost"
                  class="tab-btn px-4 py-1.5 text-xs md:text-sm rounded-full font-medium bg-indigo-500 text-white shadow">
            Host
          </button>
          <button id="tabViewer"
                  class="tab-btn px-4 py-1.5 text-xs md:text-sm rounded-full font-medium text-slate-300">
            Viewer
          </button>
        </div>

        <div class="text-right text-[11px] md:text-xs text-slate-400">
          <div>Role: <span id="roleStatus" class="font-semibold text-slate-100">Belum dipilih</span></div>
          <div>Koneksi: <span id="connectionStatus" class="font-semibold text-amber-300">Idle</span></div>
        </div>
      </div>

      <!-- HOST SECTION -->
      <section id="hostSection" class="space-y-4 mt-2">
        <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4 flex flex-col gap-3 md:flex-row md:items-center">
          <div class="flex-1">
            <h2 class="text-sm md:text-base font-semibold mb-1">
              Mode Host (berbagi layar)
            </h2>
            <p class="text-xs md:text-sm text-slate-400">
              Isi password, lalu klik tombol mulai. Sistem akan buat Room ID dan link otomatis yang bisa kamu kirim ke viewer.
            </p>
          </div>
          <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2">
            <input id="hostPassword"
                   type="password"
                   placeholder="Password room (contoh: bocco-123)"
                   class="w-full md:w-56 px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 text-xs md:text-sm placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            <button id="btnHostStart"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-xs md:text-sm font-semibold shadow">
              Mulai sebagai Host
            </button>
          </div>
        </div>

        <!-- INFO ROOM & LINK -->
        <div id="hostInfoBox" class="hidden bg-slate-900/70 border border-indigo-500/50 rounded-xl p-4 space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="text-xs md:text-sm">
              <div class="text-slate-400">Room ID</div>
              <div id="roomIdDisplay" class="font-mono text-sm md:text-base text-indigo-300">-</div>
            </div>
            <div class="text-xs md:text-sm">
              <div class="text-slate-400">Status</div>
              <div class="font-semibold text-emerald-400" id="hostStatusText">Room dibuat, menunggu viewer...</div>
            </div>
          </div>

          <div class="space-y-1">
            <div class="text-xs text-slate-400">Link untuk viewer</div>
            <div class="flex flex-col md:flex-row gap-2">
              <input id="roomLink"
                     type="text"
                     readonly
                     class="flex-1 px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 text-[11px] md:text-xs font-mono text-slate-200" />
              <button id="btnCopyLink"
                      class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs md:text-sm font-medium">
                Copy link
              </button>
            </div>
            <p class="text-[11px] text-slate-500">
              Kirim link ini + password ke viewer. Viewer cukup buka link dan isi password.
            </p>
          </div>
        </div>
      </section>

      <!-- VIEWER SECTION -->
      <section id="viewerSection" class="space-y-4 mt-2 hidden">
        <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4 flex flex-col md:flex-row gap-3 md:items-center">
          <div class="flex-1">
            <h2 class="text-sm md:text-base font-semibold mb-1">
              Mode Viewer
            </h2>
            <p class="text-xs md:text-sm text-slate-400">
              Biasanya kamu akan join dari link yang dikirim host. Kalau mau manual, isi Room ID dan password di sini.
            </p>
          </div>
          <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2">
            <input id="viewerRoomId"
                   type="text"
                   placeholder="Room ID"
                   class="w-full md:w-48 px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 text-xs md:text-sm placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            <input id="viewerPassword"
                   type="password"
                   placeholder="Password room"
                   class="w-full md:w-48 px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 text-xs md:text-sm placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            <button id="btnViewerManual"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs md:text-sm font-semibold">
              Gabung manual
            </button>
          </div>
        </div>

        <p class="text-[11px] text-slate-500">
          Kalau halaman ini dibuka dari link host (ada <code>?room=...</code>), bakal muncul modal password otomatis.
        </p>
      </section>

      <!-- VIDEO AREA (FULL WIDTH PER ROLE) -->
      <div class="mt-4 space-y-4">
        <!-- LOCAL (HOST PREVIEW) -->
        <div id="localCard" class="max-w-3xl mx-auto bg-slate-900/70 border border-slate-800 rounded-xl p-3 space-y-2" data-aos="fade-up">
          <div class="flex items-center justify-between">
            <h3 class="text-xs md:text-sm font-semibold">Layar kamu (host)</h3>
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300">
              Hanya terlihat di sisi host
            </span>
          </div>
          <div class="aspect-video bg-slate-950 rounded-lg overflow-hidden flex items-center justify-center">
            <video id="localVideo" autoplay playsinline muted class="w-full h-full object-contain"></video>
          </div>
          <p class="text-[11px] text-slate-500">
            Saat share screen aktif, preview layar akan muncul di sini.
          </p>
        </div>

        <!-- REMOTE (VIEWER VIEW) -->
        <div id="remoteCard" class="max-w-3xl mx-auto bg-slate-900/70 border border-slate-800 rounded-xl p-3 space-y-2 hidden" data-aos="fade-up">
          <div class="flex items-center justify-between">
            <h3 class="text-xs md:text-sm font-semibold">Layar host</h3>
            <button id="btnFullscreen"
                    class="text-[11px] px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700">
              Fullscreen
            </button>
          </div>
          <div class="aspect-video bg-slate-950 rounded-lg overflow-hidden flex items-center justify-center">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-contain"></video>
          </div>
          <p class="text-[11px] text-slate-500">
            Di sini kamu akan melihat layar dari host. Kalau mau fokus, pakai tombol fullscreen.
          </p>
        </div>
      </div>

      <!-- FOOTER CONTROL -->
      <div class="flex items-center justify-between flex-wrap gap-2 mt-3 pt-3 border-t border-slate-800">
        <button id="btnHangup"
                class="px-4 py-2 rounded-lg bg-rose-600/80 hover:bg-rose-600 text-xs md:text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed"
                disabled>
          Akhiri koneksi
        </button>

        <span class="text-[10px] md:text-[11px] text-slate-500">
          Bocco Â· WebRTC + Firebase
        </span>
      </div>
    </div>
  </div>

  <!-- PASSWORD MODAL UNTUK VIEWER (LINK MODE) -->
  <div id="passwordModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40 hidden">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl p-5 w-full max-w-sm shadow-2xl">
      <h2 class="text-sm md:text-base font-semibold mb-2">
        Masuk ke room
      </h2>
      <p class="text-xs text-slate-400 mb-3">
        Masukkan password yang dikirim host. Kalau benar, layar host akan langsung tampil.
      </p>
      <input id="modalPasswordInput"
             type="password"
             placeholder="Password room"
             class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 text-xs md:text-sm placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 mb-3" />
      <div class="flex justify-end gap-2">
        <button id="modalCancelBtn"
                class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs md:text-sm">
          Batal
        </button>
        <button id="modalJoinBtn"
                class="px-3 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-xs md:text-sm font-semibold">
          Gabung
        </button>
      </div>
    </div>
  </div>

  <script>
    // Init AOS
    AOS.init({ duration: 700, once: true });

    // iziToast helper
    function toastSuccess(msg) {
      iziToast.success({
        title: 'OK',
        message: msg,
        position: 'topRight'
      });
    }
    function toastError(msg) {
      iziToast.error({
        title: 'Error',
        message: msg,
        position: 'topRight'
      });
    }
    function toastInfo(msg) {
      iziToast.info({
        title: 'Info',
        message: msg,
        position: 'topRight'
      });
    }

    // ====== FIREBASE INIT (CONFIG KAMU) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDF5mcwdCbdBdYzkzgtUWLTQJoc_kMLlyQ",
      authDomain: "bocco-screen.firebaseapp.com",
      databaseURL: "https://bocco-screen-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "bocco-screen",
      storageBucket: "bocco-screen.firebasestorage.app",
      messagingSenderId: "585522231994",
      appId: "1:585522231994:web:9cf8e9fe29e2bb2318e083",
      measurementId: "G-ZRFHFT31QH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ====== DOM ELEMENTS ======
    const tabHost = document.getElementById('tabHost');
    const tabViewer = document.getElementById('tabViewer');
    const hostSection = document.getElementById('hostSection');
    const viewerSection = document.getElementById('viewerSection');

    const roleStatus = document.getElementById('roleStatus');
    const connectionStatus = document.getElementById('connectionStatus');

    const hostPasswordInput = document.getElementById('hostPassword');
    const btnHostStart = document.getElementById('btnHostStart');

    const hostInfoBox = document.getElementById('hostInfoBox');
    const roomIdDisplay = document.getElementById('roomIdDisplay');
    const roomLinkInput = document.getElementById('roomLink');
    const btnCopyLink = document.getElementById('btnCopyLink');
    const hostStatusText = document.getElementById('hostStatusText');

    const viewerRoomIdInput = document.getElementById('viewerRoomId');
    const viewerPasswordInput = document.getElementById('viewerPassword');
    const btnViewerManual = document.getElementById('btnViewerManual');

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const btnHangup = document.getElementById('btnHangup');

    const localCard = document.getElementById('localCard');
    const remoteCard = document.getElementById('remoteCard');

    const passwordModal = document.getElementById('passwordModal');
    const modalPasswordInput = document.getElementById('modalPasswordInput');
    const modalJoinBtn = document.getElementById('modalJoinBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    // ====== TABS ======
    function setActiveTab(tab) {
      if (tab === 'host') {
        tabHost.classList.add('bg-indigo-500', 'text-white', 'shadow');
        tabViewer.classList.remove('bg-indigo-500', 'text-white', 'shadow');
        tabViewer.classList.add('text-slate-300');
        hostSection.classList.remove('hidden');
        viewerSection.classList.add('hidden');

        // Host hanya lihat preview-nya
        localCard.classList.remove('hidden');
        remoteCard.classList.add('hidden');
      } else {
        tabViewer.classList.add('bg-indigo-500', 'text-white', 'shadow');
        tabHost.classList.remove('bg-indigo-500', 'text-white', 'shadow');
        tabHost.classList.add('text-slate-300');
        viewerSection.classList.remove('hidden');
        hostSection.classList.add('hidden');

        // Viewer hanya lihat layar host
        remoteCard.classList.remove('hidden');
        localCard.classList.add('hidden');
      }
    }

    tabHost.addEventListener('click', () => setActiveTab('host'));
    tabViewer.addEventListener('click', () => setActiveTab('viewer'));

    // Auto set tab jika ada ?room= di URL (anggap viewer)
    const params = new URLSearchParams(window.location.search);
    const qRoom = params.get('room');
    if (qRoom) {
      viewerRoomIdInput.value = qRoom;
      setActiveTab('viewer');
      roleStatus.textContent = 'Belum dipilih (link viewer terdeteksi)';
      connectionStatus.textContent = 'Menunggu password viewer...';

      // Tampilkan modal password
      setTimeout(() => {
        passwordModal.classList.remove('hidden');
        modalPasswordInput.value = '';
        modalPasswordInput.focus();
      }, 400);
    } else {
      setActiveTab('host');
    }

    // ====== STATUS HELPERS ======
    function setRoleStatusText(text) {
      roleStatus.textContent = text;
    }
    function setConnectionStatusText(text) {
      connectionStatus.textContent = text;
    }

    // ====== WEBRTC ======
    const pcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };
    let pc = null;
    let localStream = null;
    let roomRef = null;
    let role = null; // 'broadcaster' atau 'viewer'

    let answerListener = null;
    let broadcasterCandidatesListener = null;
    let viewerCandidatesListener = null;
    let hostStarted = false;
    let wasConnected = false;

    function createPeerConnection() {
      pc = new RTCPeerConnection(pcConfig);
      wasConnected = false;

      pc.onicecandidate = event => {
        if (!event.candidate || !roomRef || !role) return;
        const path = (role === 'broadcaster')
          ? roomRef.child('broadcasterCandidates')
          : roomRef.child('viewerCandidates');
        path.push(event.candidate.toJSON());
      };

      pc.ontrack = event => {
        const [stream] = event.streams;
        remoteVideo.srcObject = stream;
        setConnectionStatusText('Terhubung');
        wasConnected = true;
      };

      pc.oniceconnectionstatechange = () => {
        if (!pc) return;
        const state = pc.iceConnectionState;
        console.log('ICE state:', state);

        if (state === 'checking') {
          setConnectionStatusText('Menghubungkan...');
        } else if (state === 'connected' || state === 'completed') {
          setConnectionStatusText('Terhubung');
          wasConnected = true;
          if (role === 'broadcaster') {
            hostStatusText.textContent = 'Terhubung dengan viewer.';
          }
          toastSuccess('Koneksi tersambung.');
        } else if (state === 'disconnected') {
          setConnectionStatusText('Terputus, mencoba reconnect...');
          if (wasConnected) {
            toastInfo('Koneksi sempat terputus. Kalau tidak kembali, akhiri dan mulai ulang.');
          }
        } else if (state === 'failed') {
          setConnectionStatusText('Gagal menghubungkan');
          if (wasConnected) {
            toastError('Koneksi gagal. Coba tutup dan mulai ulang.');
          }
        } else if (state === 'closed') {
          setConnectionStatusText('Koneksi ditutup');
        }
      };
    }

    // ====== FIREBASE ROOM UTIL ======
    async function checkOrCreateRoomAsBroadcaster(roomId, password) {
      roomRef = db.ref('rooms/' + roomId);
      const snap = await roomRef.once('value');
      const data = snap.val();

      if (data && data.password && data.password !== password) {
        throw new Error('Password room tidak cocok dengan yang sudah ada.');
      }
      if (!data) {
        await roomRef.set({
          password: password,
          createdAt: Date.now()
        });
      }
    }

    async function checkRoomAsViewer(roomId, password) {
      roomRef = db.ref('rooms/' + roomId);
      const snap = await roomRef.once('value');
      const data = snap.val();

      if (!data) throw new Error('Room belum dibuat oleh host.');
      if (data.password !== password) throw new Error('Password salah.');
    }

    // Generate Room ID simple
    function generateRoomId() {
      const part1 = Math.random().toString(36).substring(2, 6);
      const part2 = Date.now().toString(36).substring(4);
      return `room-${part1}-${part2}`;
    }

    // ====== HOST START ======
    btnHostStart.addEventListener('click', async () => {
      if (hostStarted) {
        toastInfo('Host sudah berjalan. Kalau mau ulang, refresh halaman dulu.');
        return;
      }
      if (role && role !== 'broadcaster') {
        toastError('Kamu sekarang berperan sebagai viewer. Refresh halaman kalau mau jadi host.');
        return;
      }

      const password = hostPasswordInput.value.trim();
      if (!password) {
        toastError('Password room tidak boleh kosong.');
        return;
      }

      hostStarted = true;
      btnHostStart.disabled = true;

      const roomId = generateRoomId();
      const roomLink = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(roomId)}`;

      try {
        await checkOrCreateRoomAsBroadcaster(roomId, password);

        createPeerConnection();
        role = 'broadcaster';
        setRoleStatusText('Host');
        setConnectionStatusText('Menyiapkan share screen...');
        hostPasswordInput.disabled = true;

        // getDisplayMedia
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => {
          track.onended = () => {
            toastInfo('Screen share berhenti.');
            setConnectionStatusText('Screen share berhenti');
          };
          pc.addTrack(track, localStream);
        });

        // Buat offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.child('offer').set({
          type: offer.type,
          sdp: offer.sdp
        });

        // Update UI Room
        roomIdDisplay.textContent = roomId;
        roomLinkInput.value = roomLink;
        hostInfoBox.classList.remove('hidden');
        hostStatusText.textContent = 'Offer dikirim, menunggu viewer join...';
        setConnectionStatusText('Menunggu viewer...');
        toastSuccess('Room dibuat. Link siap dikirim ke viewer.');

        // Listener Answer dari viewer
        answerListener = roomRef.child('answer').on('value', async snap => {
          const answer = snap.val();
          if (!answer) return;
          if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            hostStatusText.textContent = 'Viewer sudah menjawab. Menghubungkan...';
            setConnectionStatusText('Menghubungkan...');
          }
        });

        // Listener ICE viewer
        viewerCandidatesListener = roomRef.child('viewerCandidates').on('child_added', async snap => {
          const candidate = snap.val();
          if (candidate && pc) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
              console.error('Gagal add viewer ICE candidate:', e);
            }
          }
        });

        btnHangup.disabled = false;
      } catch (err) {
        console.error(err);
        toastError('Gagal mulai sebagai host: ' + err.message);
        setConnectionStatusText('Error');
        hostStarted = false;
        btnHostStart.disabled = false;
        hostPasswordInput.disabled = false;
      }
    });

    // Copy link
    btnCopyLink.addEventListener('click', async () => {
      const link = roomLinkInput.value.trim();
      if (!link) return;
      try {
        await navigator.clipboard.writeText(link);
        toastSuccess('Link room disalin ke clipboard.');
      } catch {
        toastInfo('Clipboard tidak bisa dipakai, kamu bisa salin manual.');
      }
    });

    // ====== VIEWER START (MANUAL) ======
    btnViewerManual.addEventListener('click', () => {
      const roomId = viewerRoomIdInput.value.trim();
      const password = viewerPasswordInput.value.trim();
      if (!roomId || !password) {
        toastError('Room ID dan password wajib diisi.');
        return;
      }
      startViewer(roomId, password);
    });

    // ====== VIEWER START (CORE) ======
    async function startViewer(roomId, password) {
      if (role && role !== 'viewer') {
        toastError('Kamu sekarang berperan sebagai host. Refresh halaman kalau mau jadi viewer.');
        return;
      }

      try {
        await checkRoomAsViewer(roomId, password);

        createPeerConnection();
        role = 'viewer';
        setRoleStatusText('Viewer');
        setConnectionStatusText('Mengambil data dari host...');

        // Ambil offer
        const offerSnap = await roomRef.child('offer').once('value');
        const offer = offerSnap.val();
        if (!offer) {
          throw new Error('Host belum mulai share screen.');
        }

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        // Buat answer
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.child('answer').set({
          type: answer.type,
          sdp: answer.sdp
        });

        setConnectionStatusText('Menghubungkan...');

        // Listener ICE dari host
        broadcasterCandidatesListener = roomRef.child('broadcasterCandidates').on('child_added', async snap => {
          const candidate = snap.val();
          if (candidate && pc) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
              console.error('Gagal add host ICE candidate:', e);
            }
          }
        });

        btnHangup.disabled = false;
        toastSuccess('Berhasil join sebagai viewer.');
      } catch (err) {
        console.error(err);
        toastError('Gagal join sebagai viewer: ' + err.message);
        setConnectionStatusText('Error');
      }
    }

    // ====== PASSWORD MODAL HANDLER (VIEWER LINK MODE) ======
    modalJoinBtn.addEventListener('click', () => {
      const pwd = modalPasswordInput.value.trim();
      if (!pwd) {
        toastError('Password tidak boleh kosong.');
        return;
      }
      const roomId = viewerRoomIdInput.value.trim();
      if (!roomId) {
        toastError('Room ID tidak ditemukan di URL.');
        return;
      }
      passwordModal.classList.add('hidden');
      viewerPasswordInput.value = pwd;
      startViewer(roomId, pwd);
    });

    modalCancelBtn.addEventListener('click', () => {
      passwordModal.classList.add('hidden');
      toastInfo('Masuk sebagai viewer dibatalkan.');
    });

    // ====== FULLSCREEN ======
    btnFullscreen.addEventListener('click', () => {
      const elem = remoteVideo;
      if (!elem) return;
      if (elem.requestFullscreen) elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
    });

    // ====== HANGUP ======
    btnHangup.addEventListener('click', async () => {
      if (!pc && !localStream) return;

      try {
        if (pc) {
          pc.getSenders().forEach(s => s.track && s.track.stop());
          pc.close();
        }
        if (localStream) localStream.getTracks().forEach(t => t.stop());

        pc = null;
        localStream = null;

        if (answerListener && roomRef) roomRef.child('answer').off('value', answerListener);
        if (broadcasterCandidatesListener && roomRef) roomRef.child('broadcasterCandidates').off('child_added', broadcasterCandidatesListener);
        if (viewerCandidatesListener && roomRef) roomRef.child('viewerCandidates').off('child_added', viewerCandidatesListener);

        // Jika host yang hangup -> hapus room
        if (role === 'broadcaster' && roomRef) {
          await roomRef.remove();
        }

        roomRef = null;
        role = null;
        btnHangup.disabled = true;
        setRoleStatusText('Belum dipilih');
        setConnectionStatusText('Disconnected');
        toastInfo('Koneksi ditutup. Kalau mau mulai lagi, refresh halaman.');
      } catch (err) {
        console.error(err);
        toastError('Gagal menutup koneksi: ' + err.message);
      }
    });
  </script>
</body>
</html>
